{
    "sourceFile": "Modules/Media/Services/MediaService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1760283084449,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1760283084449,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace Modules\\Media\\Services;\n\nuse App\\Abstractions\\Service;\nuse Exception;\nuse Illuminate\\Support\\Facades\\DB;\nuse Modules\\Media\\Repositories\\MediaRepository;\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Support\\Facades\\Storage;\nuse Modules\\Media\\Helpers\\FileHelper;\nuse Intervention\\Image\\ImageManager as Image;\nuse Spatie\\LaravelImageOptimizer\\Facades\\ImageOptimizer;\nuse Imagick;\n\nclass MediaService extends Service\n{\n\n    protected $presets = [\n        95 => [95, 95],\n        100 => [100, 100],\n        320 => [320, 240],\n        450 => [450, 360],\n        688 => [688, 425],\n        365 => [365, 241],\n        480 => [450, 360],\n        137 => [137, 45],\n        270 => [270, 298],\n        285 => [285, 350]\n    ];\n\n    public function __construct(protected MediaRepository $mediaRepository) {}\n\n\n    public function imageOptimizer():static\n    {\n        if(function_exists('proc_open') and function_exists('escapeshellarg')){\n            ImageOptimizer::optimize(storage_path(\"app/public/\". $this->getInput('file_path')));\n        }\n        return $this;\n    }\n\n    public function folderGenerate($id): static\n    {\n        $folder = '';\n        $file = $this->getInput('file');\n        if ($id) {\n            $folder .= sprintf('%04d', (int)$id / 1000) . '/' . $id . '/';\n        }\n        $folder = $folder . date('Y/m/d');\n        $newFileName = Str::slug(substr($file->getClientOriginalName(), 0, strrpos($file->getClientOriginalName(), '.')));\n        if(empty($newFileName)) $newFileName = md5($file->getClientOriginalName());\n        $this->setInput('folder', $folder);\n        $this->setInput('file_name', $newFileName);\n\n        return $this;\n    }\n\n    public function storeFile():static\n    {\n        $newFileName = $this->getInput('file_name');\n        $folder = $this->getInput('folder');\n        $file = $this->getInput('file');\n        $extension = $file->getClientOriginalExtension();\n\n        if($extension == 'heic' || $extension == 'heif'){\n            $extension = 'png';\n        }\n\n        $i = 0;\n\n        do {\n            $newFileName2 = $newFileName . ($i ? $i : '');\n            $testPath = $folder . '/' . $newFileName2 . '.' . $extension;\n\n            $i++;\n        } while (Storage::disk('public')->exists($testPath));\n       \n        $check = $file->storeAs( $folder, $newFileName2 . '.' . $extension,'public');\n        if (env('FILESYSTEM_DRIVER') == 's3') {\n            $file->storeAs( '/public/' . $folder, $newFileName2 . '.' . $extension,'s3');\n        }\n\n        $this->heicExtension($folder, $newFileName2, $file);\n        $this->setInput('file_name', $newFileName2.\".\".$extension);\n        $this->setInput('file_path', \"/\" . $check);\n        return $this;\n\n    }\n\n    public function heicExtension($folder, $newFileName2, $file){\n\n        Image::configure(['driver' => 'imagick']);\n        $heicEx = $folder . '/' . $newFileName2 . '.png';\n\n        $imagick = new Imagick($file->path());\n        $imagick->setImageFormat('png');\n\n        $imagick = new Imagick($file->path());\n        //    $imagick->setResourceLimit(Imagick::RESOURCETYPE_MEMORY, 256); // Set memory limit in MB\n        //$imagick->setResourceLimit(Imagick::RESOURCETYPE_CPU, 2);       // Set CPU limit in seconds\n        //    $imagick->setImageFormat('png');\n        //    $imagick->thumbnailImage(100, 100);\n        //$imagick->setImageCompression(Imagick::COMPRESSION_JPEG);\n        //$imagick->setImageCompressionQuality(75); \n        // Convert to PNG\n        //$pngData = $imagick->getImageBlob();\n    \n\n        // Compress the PNG (adjust the compression quality as needed)\n        $imagick->setImageCompression(Imagick::COMPRESSION_JPEG);\n        $imagick->setImageCompressionQuality(75); //\n        // Perform any image manipulation here, e.g., resizing, filters, etc.\n        // Example: $imagick->resizeImage(200, 200, Imagick::FILTER_LANCZOS, 1);\n\n        $imagick->writeImage(public_path('storage/'.$heicEx));\n        $imagick->destroy();\n        \n    }\n\n    public function prepareFileData():static\n    {\n        $extension = $this->getInput('file')->getClientOriginalExtension();\n        if($extension == 'heic' || $extension == 'heif'){\n            $extension = 'png';\n        }\n\n        $this->setInput('file_size', $this->getInput('file')->getSize());\n        $this->setInput('file_type', $this->getInput('file')->getMimeType());\n        $this->setInput('file_extension', $extension);\n        return $this;\n    }\n\n    public function saveFile():static\n    {\n        // dd($file = $this->getInput('file')->extension(), $this->getInput('file_name'));\n        $file_name = $this->getInput('file_name');\n        $img = Image::make($this->getInput('file')->path());\n        $destinationPath = public_path('/storage/presets');\n\n       \n        $check = $this->getInput('file_path');\n        if ($check) {\n            if (FileHelper::checkMimeIsImage($this->getInput('file_type'))) {\n                list($width, $height, $type, $attr) = getimagesize(storage_path('app/public/'.$check));\n                $this->setInput('file_width', $width);\n                $this->setInput('file_height', $height);\n            }\n            $mediaFile = $this->mediaRepository->create($this->getInputs());\n            if(Storage::disk('public')->exists($mediaFile->file_path)) {\n                if($mediaFile->file_extension != 'svg' &&  FileHelper::isImage($mediaFile)) {\n                    $image = Storage::disk('public')->get($mediaFile->file_path);\n                    if($mediaFile->file_type != 'image/webp') {\n                        Image::configure(['driver' => 'imagick']);\n                        $image = Image::make($image)->stream(\"webp\", 70);\n                    }\n                    Storage::disk('public')->put(dirname($mediaFile->file_path)\n                        . '/' . str_replace(['.jpg', '.jpeg',''], '', $mediaFile->file_name) . '.webp', $image);\n\n                    if (env('FILESYSTEM_DRIVER') == 's3') {\n                        Storage::disk('s3')->put('public/' . dirname($mediaFile->file_path) . '/' .  str_replace(['.jpg', '.jpeg',''], '', $mediaFile->file_name) . '.webp',Storage::disk('public')->get(dirname($mediaFile->file_path) . '/' .  str_replace(['.jpg', '.jpeg',''], '', $mediaFile->file_name) . '.webp'));\n                    }\n                }\n            }\n            foreach ($this->presets as $preset) {\n                $directory = \"$preset[0]-$preset[1]\";\n                $response = Storage::disk('public')->makeDirectory('presets/' . $directory, intval('0775', 8), true);\n                if($response){\n                    $img->fit($preset[0], $preset[1], function ($constraint) {\n                        $constraint->aspectRatio();\n                        $constraint->upsize();\n\n                    },'left')->save($destinationPath.'/'.$directory.'/'.$this->getInput('file_name'));\n                }\n                \n            }\n\n            // Sizes use for uploaderAdapter:\n            // https://ckeditor.com/docs/ckeditor5/latest/framework/guides/deep-dive/upload-adapter.html#the-anatomy-of-the-adapter\n            $mediaFile->sizes = [\n                'default' => asset('public/' . $mediaFile->file_path),\n                '150'     => url('media/preview/'.$mediaFile->id .'/thumb'),\n                '600'     => url('media/preview/'.$mediaFile->id .'/medium'),\n                '1024'    => url('media/preview/'.$mediaFile->id .'/large'),\n            ];\n        }\n        $this->setOutput('media', $mediaFile);\n        return $this;\n    }\n\n    public function getAllMediaByAuthor(): static\n    {\n        $media = $this->mediaRepository->getAllMediaByAuthor();\n        $this->setOutput('media', $media);\n        return $this;\n    }\n\n    public function delete(): static\n    {\n        $ids = $this->getInput('ids');\n        $this->mediaRepository->delete($ids);\n        return $this;\n    }\n\n    public function getImage(): static\n    {\n        $id = $this->getInput('id');\n        $media = $this->mediaRepository->getImageById($id);\n        $this->setOutput('media', $media);\n        return $this;\n    }\n}\n"
        }
    ]
}