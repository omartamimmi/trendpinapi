{
    "sourceFile": "Modules/Shop/Services/ShopService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763291805108,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763291821893,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,9 +10,9 @@\n use Illuminate\\Support\\Facades\\DB;\n use Modules\\Location\\Models\\Location;\n use Modules\\Location\\Services\\LocationService;\n use Modules\\Notification\\Jobs\\NotifyMe;\n-use Modules\\Notification\\Jobs\\NotifyMeSelectedShop;\n+// use Modules\\Notification\\Jobs\\NotifyMeSelectedShop;\n use Modules\\Shop\\Repositories\\ShopMetaRepository;\n \n class ShopService extends Service\n {\n"
                }
            ],
            "date": 1763291805107,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace Modules\\Shop\\Services;\n\nuse App\\Abstractions\\Service;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Modules\\Shop\\Repositories\\ShopRepository;\nuse Exception;\nuse Modules\\Category\\Services\\CategoryService;\nuse Illuminate\\Support\\Facades\\DB;\nuse Modules\\Location\\Models\\Location;\nuse Modules\\Location\\Services\\LocationService;\nuse Modules\\Notification\\Jobs\\NotifyMe;\nuse Modules\\Notification\\Jobs\\NotifyMeSelectedShop;\nuse Modules\\Shop\\Repositories\\ShopMetaRepository;\n\nclass ShopService extends Service\n{\n    protected $shopRepository;\n    protected $locationService;\n    protected $shopMetaRepository;\n    protected $categoryService;\n    public function __construct(ShopRepository $shopRepository, LocationService $locationService, ShopMetaRepository $shopMetaRepository, CategoryService $categoryService)\n    {\n        $this->locationService = $locationService;\n        $this->shopRepository = $shopRepository;\n        $this->shopMetaRepository =$shopMetaRepository;\n        $this->categoryService=$categoryService;\n    }\n    public function prepareOperatingHours():array\n    {\n        $this->collectOutput('shop', $shop);\n        $enableOpenHours = $this->getInput('enable_open_hours');\n        $openHours = $this->getInput('open_hours');\n        $data = [\n            'enable_open_hours'=> $enableOpenHours,\n            'open_hours'=>$openHours\n        ];\n\n        return $data;\n    }\n\n    public function prepareDiscount():array\n    {\n        $this->collectOutput('shop', $shop);\n        $enableOpenHours = $this->getInput('enable_discount');\n        $discountType = $this->getInput('discount_type');\n        $discount = \"\";\n        switch($discountType){\n            case 'percentage':\n                $discount = $this->getInput('discount_percentage');\n                break;\n            case 'items':\n                $discount = $this->getInput('discount_items');\n                break;\n            case 'other':\n                $discount = $this->getInput('discount_description');\n                break;\n        }\n        $data = [\n            'enable_discount'=>$enableOpenHours,\n            'discount_type'=>$discountType,\n            'discount'=>$discount\n        ];\n\n        return $data;\n    }\n\n    public function storeMetaData(): static\n    {\n        $this->collectOutput('shop', $shop);\n\n        $opHours = $this->prepareOperatingHours();\n        $discount = $this->prepareDiscount();\n        $data = array_merge($opHours,$discount);\n        $data['shop_id'] = $shop->id;\n        $check = $this->shopMetaRepository->getMetaShop($shop->id);\n\n        if($check->isEmpty()){\n            $this->shopMetaRepository->create($data);\n        }else{\n            $this->shopMetaRepository->update($data, $shop->id);\n        }\n        $shops = DB::table('user_has_interest_in_shops')->select('user_id')->where('shop_id', $shop->id)->pluck('user_id');\n        $data = collect($shops)->map(function($x){ return (array) $x; })->toArray(); \n\n        $userTokens = [array_values($shops->toArray())];\n        // dd($userTokens);\n\n        // if($shops){\n        //      NotifyMeSelectedShop::dispatch($userTokens);\n        // }\n        $this->setOutput('meta', $shop->meta);\n        return $this;\n    }\n\n    public function getAllShops():static\n    {\n        $userId = Auth::id();\n        $shops = $this->shopRepository->getAllShopsByAuthor($userId);\n        $this->setOutput('shops', $shops);\n        return $this;\n    }\n\n    public function getMainBranches():static\n    {\n        $userId = Auth::id();\n        $shops = $this->shopRepository->getMainBranchesByAuthor($userId);\n        $this->setOutput('shops', $shops);\n        return $this;\n    }\n\n    public function shopsHasDiscount():static\n    {\n        $shops = $this->shopRepository->shopsHasDiscount();\n        $this->setOutput('shops', $shops);\n        return $this;\n    }\n\n    public function createShop():static\n    {\n        $shop = $this->shopRepository->create($this->getInputs());\n        $this->setOutput('shop', $shop);\n        return $this;\n    }\n\n    public function createExactLocation():static\n    {\n        $exactLocationData = $this->prepareDataBeforeCreation();\n        $this->locationService->createExactLocation($exactLocationData);\n        return $this;\n    }\n\n    public function prepareDataBeforeCreation():array\n    {\n        $this->collectOutput('shop', $shop);\n\n        $exactLocationData['exact_address'] = $this->getInput('exact_address');\n        $exactLocationData['lat'] = $this->getInput('lat');\n        $exactLocationData['lng'] = $this->getInput('lng');\n        $exactLocationData['address'] = $this->getInput('address');\n        $exactLocationData['shop_id'] = $shop->id;\n\n        return $exactLocationData;\n    }\n\n    public function updateExactLocation():static\n    {\n        $this->collectOutput('shop', $shop);\n        $exactLocationData = $this->prepareDataBeforeCreation();\n        $this->locationService->updateExactLocation($shop->id,$exactLocationData);\n        return $this;\n    }\n\n    public function updateShop():static\n    {\n        $shop = $this->shopRepository->getShopById($this->getInput('id'));\n        $this->checkAuthority($shop);\n        $this->shopRepository->update($this->getInput('id'), $this->getInputs());\n        $this->setOutput('shop', $shop);\n\n        return $this;\n    }\n\n    public function getShop():static\n    {\n        $shop = $this->shopRepository->getShopById($this->getInput('id'));\n        $this->setInput('main_branch_id',(string)$shop->main_branch_id);\n\n        $branches = $this->shopRepository->getShopByIdWithBranches($this->getInput('id'), $this->getInput('main_branch_id'));\n\n        $cats = [];\n        if(!empty($shop)){\n            foreach($shop->category_shops()->get() as $cat){\n                array_push($cats, ['id'=>$cat->id, 'name'=>$cat->name]);\n            }\n        }\n        $location = Location::where('shop_id', $shop->id)->first();\n\n        $exLocation=[\n            'address' => $location->address ?? '',\n            'lat'=> $location->lat ?? '',\n            'lng'=>$location->lng ?? ''\n        ];\n        $gallery = $shop->getGallery();\n\n        $this->setOutput('shop', $shop);\n        $this->setOutput('categories', $cats);\n        $this->setOutput('location', $exLocation);\n        $this->setOutput('galleryUrls', $gallery);\n        $this->setOutput('meta', $shop->meta);\n        $this->setOutput('branches', $branches);\n        return $this;\n    }\n\n    public function bulkDeleteShops():static\n    {\n        $ids = $this->getInput('id');\n        $this->shopRepository->deleteShop($ids);\n        return $this;\n    }\n\n    public function syncCategory():static\n    {\n        $this->collectOutput('shop', $shop);\n        $shop->category_shops()->sync($this->getInput('category'));\n        return $this;\n    }\n\n    public function syncTag():static\n    {\n        $this->collectOutput('shop', $shop);\n        $shop->tag_shops()->sync($this->getInput('tags'));\n        return $this;\n    }\n    \n    public function checkAuthority($shop)\n    {   \n        if($shop->create_user != Auth::user()->id){\n            return throw new Exception('unauthorized', 403);\n        }\n    }\n\n    public function updateShopStatus():static\n    {\n        $shop = $this->shopRepository->getShopById($this->getInput('shop_id'));\n        $this->checkAuthority($shop);\n        $this->shopRepository->updateShopStatus($this->getInput('shop_id'), $this->getInputs());\n\n        return $this;\n    }\n\n    public function deleteShop():static\n    {\n        $shop = $this->shopRepository->getShopById($this->getInput('shop_id'));\n        $this->checkAuthority($shop);\n        $this->shopRepository->deleteShop($this->getInput('shop_id'));\n\n        return $this;\n    }\n\n    public function getShopByAuthor():static\n    {\n        $shop = $this->shopRepository->getShopById($this->getInput('id'));\n        $this->checkAuthority($shop);\n\n        $cats = [];\n        if(!empty($shop)){\n            foreach($shop->category_shops()->get() as $cat){\n                array_push($cats, ['id'=>$cat->id, 'name'=>$cat->name]);\n            }\n        }\n        $location = Location::where('shop_id', $shop->id)->first();\n\n        $exLocation=[\n            'address' => $location->address,\n            'lat'=> $location->lat,\n            'lng'=>$location->lng\n        ];\n        $gallery = $shop->getGallery();\n\n        $this->setOutput('shop', $shop);\n        $this->setOutput('categories', $cats);\n        $this->setOutput('location', $exLocation);\n        $this->setOutput('galleryUrls', $gallery);\n        $this->setOutput('meta', $shop->meta);\n        return $this;\n    }\n\n    public function getAllCategories():static\n    {\n        $categories = $this->categoryService->getAllCategories();\n        $categories->collectOutput('categories', $categories);\n        $this->setOutput('categories',$categories);\n        return $this;\n    }\n\n    public function getAllCities():static\n    {\n        $cities = $this->locationService->getAllCity();\n        $cities->collectOutput('cities', $cities);\n        $this->setOutput('cities',$cities);\n\n        return $this;\n    }\n\n    public function createBranch()\n    {\n        $branchId = $this->getInput('branch_id');\n        $this->setInput('is_main_branch',1);\n        $this->checkBranch();\n        if(!empty($branchId)){\n            $this->setInput('main_branch_id', $branchId);\n            $this->setInput('is_main_branch',0);\n        }\n        return $this;\n    }\n\n    public function checkBranch()\n    {\n        $branchId = $this->getInput('branch_id');\n        $shop = $this->shopRepository->getShopById($branchId);\n        $this->setInput('is_main_branch',1);\n        if(!empty($branchId) && !($shop->is_main_branch == 1)){\n            return throw new Exception('The branch should be a main business', 400);\n        }\n        return $this;\n    }\n\n    public function createMainBranch()\n    {\n        $this->setInput('is_main_branch',1);\n        return $this;\n    }\n\n}\n"
        }
    ]
}