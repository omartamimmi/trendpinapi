{
    "sourceFile": "Modules/User/Services/AuthService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 13,
            "patches": [
                {
                    "date": 1758214285271,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1758214293206,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,9 @@\n use Illuminate\\Support\\Facades\\Hash;\n use Modules\\Otp\\Services\\OtpService;\n use Modules\\User\\Repositories\\UserRepository;\n \n-class AuthService extends Serv\n+class AuthService extends \n {\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n"
                },
                {
                    "date": 1758214357066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,9 @@\n use Illuminate\\Support\\Facades\\Hash;\n use Modules\\Otp\\Services\\OtpService;\n use Modules\\User\\Repositories\\UserRepository;\n \n-class AuthService extends \n+class AuthService extends Service\n {\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n"
                },
                {
                    "date": 1758214390915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n \n-    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, OtpService $otpService)\n+    public function __construct(UserRepository $userRepository, LogoutUserServic $logoutUserService, OtpService $otpService)\n     {\n         $this->userRepository = $userRepository;\n         $this->logoutUserService = $logoutUserService;\n         $this->otpService = $otpService;\n"
                },
                {
                    "date": 1758214396564,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n \n-    public function __construct(UserRepository $userRepository, LogoutUserServic $logoutUserService, OtpService $otpService)\n+    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, Modules\\User\\Services\\OtpService $otpService)\n     {\n         $this->userRepository = $userRepository;\n         $this->logoutUserService = $logoutUserService;\n         $this->otpService = $otpService;\n"
                },
                {
                    "date": 1758214404991,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n \n-    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, Modules\\User\\Services\\OtpService $otpService)\n+    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, $otpService)\n     {\n         $this->userRepository = $userRepository;\n         $this->logoutUserService = $logoutUserService;\n         $this->otpService = $otpService;\n"
                },
                {
                    "date": 1758214414034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n \n-    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, $otpService)\n+    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService,Modules\\User\\Services\\OtpService $otpService)\n     {\n         $this->userRepository = $userRepository;\n         $this->logoutUserService = $logoutUserService;\n         $this->otpService = $otpService;\n"
                },
                {
                    "date": 1758214423600,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n \n-    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService,Modules\\User\\Services\\OtpService $otpService)\n+    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, OtpService $otpService)\n     {\n         $this->userRepository = $userRepository;\n         $this->logoutUserService = $logoutUserService;\n         $this->otpService = $otpService;\n"
                },
                {
                    "date": 1758214428663,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,8 +8,9 @@\n use Illuminate\\Support\\Facades\\Auth;\n use Illuminate\\Support\\Facades\\Hash;\n use Modules\\Otp\\Services\\OtpService;\n use Modules\\User\\Repositories\\UserRepository;\n+use Modules\\User\\Services\\OtpService;\n \n class AuthService extends Service\n {\n     protected $userRepository;\n"
                },
                {
                    "date": 1758214437909,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,8 @@\n use Carbon\\Carbon;\n use Exception;\n use Illuminate\\Support\\Facades\\Auth;\n use Illuminate\\Support\\Facades\\Hash;\n-use Modules\\Otp\\Services\\OtpService;\n use Modules\\User\\Repositories\\UserRepository;\n use Modules\\User\\Services\\OtpService;\n \n class AuthService extends Service\n"
                },
                {
                    "date": 1758214443299,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,8 @@\n use Exception;\n use Illuminate\\Support\\Facades\\Auth;\n use Illuminate\\Support\\Facades\\Hash;\n use Modules\\User\\Repositories\\UserRepository;\n-use Modules\\User\\Services\\OtpService;\n \n class AuthService extends Service\n {\n     protected $userRepository;\n"
                },
                {
                    "date": 1758214456473,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,13 +14,13 @@\n     protected $userRepository;\n     protected $logoutUserService;\n     protected $otpService;\n \n-    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, OtpService $otpService)\n+    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService)\n     {\n         $this->userRepository = $userRepository;\n         $this->logoutUserService = $logoutUserService;\n-        $this->otpService = $otpService;\n+        // $this->otpService = $otpService;\n     }\n \n \n     public function getAuthUser()\n"
                },
                {
                    "date": 1758214480128,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,9 +12,9 @@\n class AuthService extends Service\n {\n     protected $userRepository;\n     protected $logoutUserService;\n-    protected $otpService;\n+    // protected $otpService;\n \n     public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService)\n     {\n         $this->userRepository = $userRepository;\n@@ -31,9 +31,9 @@\n \n     public function persistUserBasicInfo():static\n     {\n         $data = $this->getInputs();\n-        $phone = $this->otpService->verify($data['phone_number'], $data['code']);\n+        // $phone = $this->otpService->verify($data['phone_number'], $data['code']);\n         $user = $this->userRepository->create($data);\n         $this->setOutput('user', $user);\n         return $this;\n     }\n"
                },
                {
                    "date": 1758214485410,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -163,9 +163,9 @@\n \n     public function sendVerifications():static\n     {\n         $data = $this->getInputs();\n-        $phone = $this->otpService->send($data['phone_number'], 'sms');\n+        // $phone = $this->otpService->send($data['phone_number'], 'sms');\n dd($phone);\n         return $this;\n     }\n }\n"
                }
            ],
            "date": 1758214285271,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace Modules\\User\\Services;\n\nuse App\\Abstractions\\Service;\nuse Carbon\\Carbon;\nuse Exception;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Hash;\nuse Modules\\Otp\\Services\\OtpService;\nuse Modules\\User\\Repositories\\UserRepository;\n\nclass AuthService extends Serv\n{\n    protected $userRepository;\n    protected $logoutUserService;\n    protected $otpService;\n\n    public function __construct(UserRepository $userRepository, LogoutUserService $logoutUserService, OtpService $otpService)\n    {\n        $this->userRepository = $userRepository;\n        $this->logoutUserService = $logoutUserService;\n        $this->otpService = $otpService;\n    }\n\n\n    public function getAuthUser()\n    {\n        $user = Auth::user();\n        return $user;\n    }\n\n    public function persistUserBasicInfo():static\n    {\n        $data = $this->getInputs();\n        $phone = $this->otpService->verify($data['phone_number'], $data['code']);\n        $user = $this->userRepository->create($data);\n        $this->setOutput('user', $user);\n        return $this;\n    }\n\n    public function assignRoleToUser():static\n    {\n        $role = $this->getInput('role');\n        $this->collectOutput('user', $user);\n        if($role){\n            $user->assignRole($role);\n        }\n        return $this;\n    }\n\n    public function attemptAuthentication(): static\n    {\n        $email = $this->getInput('email');\n        $password = $this->getInput('password');\n        $remember = $this->getInput('remember');\n        $authAttempt = Auth::attempt(['email' => $email, 'password' => $password], $remember);\n        if (!$authAttempt) {\n            throw new Exception(__('validation.password or email incorrect'), 403);\n        }\n        return $this;\n    }\n\n    public function setAuthUser(int $id): static\n    {\n        $user = $this->userRepository->getUserById($id);\n        $this->setOutput('user', $user);\n        return $this;\n    }\n\n    public function collectUser(&$user): static\n    {\n        $this->collectOutput('user', $user);\n        return $this;\n    }\n\n    public function checkIfUserBlocked(): static\n    {\n        $this->collectUser($user);\n        if (in_array($user->status, ['blocked'])) {\n            $this->logoutUserService\n                ->setAuthUser($user->id)\n                ->revokeToken();\n            throw new Exception(__('Your account has been blocked'), 401);\n        }\n        return $this;\n    }\n\n    public function updateLastLogin(): static\n    {\n        $this->collectUser($user);\n        $this->userRepository->update($user->id, [\n            'last_login_at' => Carbon::now()\n        ]);\n        return $this;\n    }\n\n    public function createUserLoginToken(): static\n    {\n        $this->collectUser($user);\n        // Create sanctum login token with expiry date 1 month from creation\n        $token = $user->createToken('login-token', ['*'], Carbon::now()->addMonth());\n        $loginArray = [\n            'data' => [\n                'id' => $user->id,\n                'name' => $user->name,\n                'email' => $user->email,\n                'phone' => $user->phone,\n                'role' => $user->getRoleNames()[0] ?? null,\n                'type' => 'Bearer',\n                'access_token' => $token->plainTextToken,\n                'expires_at' => $token->accessToken->expires_at\n            ]\n        ];\n        $this->setOutputs($loginArray);\n        return $this;\n    }\n\n    public function getUserData(): static\n    {\n        $lang = $this->getInput('lang');\n        $userId = $this->getAuthUser()->id;\n        $user = $this->userRepository->getUserById($userId);\n        $this->setOutput('user', $user);\n        return $this;\n    }\n\n    public function updateProfile(): static\n    {\n        $this->collectUser($user);\n        $this->userRepository->update($user->id, $this->getInputs(), $this->getInput('lang', 'en'));\n        return $this;\n    }\n\n    public function ChangeMyPassword():static\n    {\n        $id = $this->getInput('authId');\n        $password = Hash::make($this->getInput('password'));\n        $this->userRepository->updatePassword($id,$password);\n\n        return $this;\n    }\n\n    public function persistUserBasicInfoForSocialLogin():static\n    {\n        $data = $this->getInputs();\n        $user = null;\n        if(isset($data['email'])){\n            $user = $this->userRepository->findUserByEmail($data['email']);\n        }\n        if(isset($data['appleId']) && empty($user)){\n            $user = $this->userRepository->findUserByAppleId($data['appleId']);\n        }\n        $this->setOutput('user', $user);\n\n        if(empty($user)){\n            $this->setInput('role', 'customer');\n            $user = $this->userRepository->create($data);\n            $this->setOutput('user', $user);\n            $this->assignRoleToUser();\n        }\n        return $this;\n    }\n\n    public function sendVerifications():static\n    {\n        $data = $this->getInputs();\n        $phone = $this->otpService->send($data['phone_number'], 'sms');\ndd($phone);\n        return $this;\n    }\n}\n"
        }
    ]
}