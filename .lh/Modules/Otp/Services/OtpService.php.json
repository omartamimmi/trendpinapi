{
    "sourceFile": "Modules/Otp/Services/OtpService.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763887973106,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763887984856,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,8 +29,9 @@\n      * Send OTP to phone number\n      */\n     public function send(string $phoneNumber, string $channel = 'sms'): PhoneVerification\n     {\n+        dd\n         // Delete any existing unverified codes for this phone\n         PhoneVerification::where('phone_number', $phoneNumber)\n             ->whereNull('verified_at')\n             ->delete();\n"
                },
                {
                    "date": 1763888123539,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,9 +13,8 @@\n     protected ?string $twilioFrom = null;\n \n     public function __construct()\n     {\n-        dd(123);\n         $sid = config('otp.twilio.sid');\n         $token = config('otp.twilio.token');\n         $from = config('otp.twilio.from');\n \n@@ -29,9 +28,8 @@\n      * Send OTP to phone number\n      */\n     public function send(string $phoneNumber, string $channel = 'sms'): PhoneVerification\n     {\n-        dd\n         // Delete any existing unverified codes for this phone\n         PhoneVerification::where('phone_number', $phoneNumber)\n             ->whereNull('verified_at')\n             ->delete();\n"
                }
            ],
            "date": 1763887973106,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace Modules\\Otp\\Services;\n\nuse Modules\\Otp\\app\\Models\\PhoneVerification;\nuse Twilio\\Rest\\Client;\nuse Twilio\\Exceptions\\TwilioException;\nuse Exception;\n\nclass OtpService\n{\n    protected ?Client $twilioClient = null;\n    protected ?string $twilioFrom = null;\n\n    public function __construct()\n    {\n        dd(123);\n        $sid = config('otp.twilio.sid');\n        $token = config('otp.twilio.token');\n        $from = config('otp.twilio.from');\n\n        if ($sid && $token && $from) {\n            $this->twilioClient = new Client($sid, $token);\n            $this->twilioFrom = $from;\n        }\n    }\n\n    /**\n     * Send OTP to phone number\n     */\n    public function send(string $phoneNumber, string $channel = 'sms'): PhoneVerification\n    {\n        // Delete any existing unverified codes for this phone\n        PhoneVerification::where('phone_number', $phoneNumber)\n            ->whereNull('verified_at')\n            ->delete();\n\n        // Generate a 6-digit code\n        $code = $this->generateCode();\n\n        // Create the verification record\n        $verification = PhoneVerification::create([\n            'phone_number' => $phoneNumber,\n            'code' => $code,\n            'expires_at' => now()->addMinutes(config('otp.expiry_minutes', 10)),\n        ]);\n\n        // Send the code via Twilio\n        $this->sendViaTwilio($phoneNumber, $code);\n\n        return $verification;\n    }\n\n    /**\n     * Verify OTP code\n     */\n    public function verify(string $phoneNumber, string $code): bool\n    {\n        $verification = PhoneVerification::where('phone_number', $phoneNumber)\n            ->whereNull('verified_at')\n            ->latest()\n            ->first();\n\n        if (!$verification) {\n            throw new Exception(__('otp::messages.verification_not_found'));\n        }\n\n        if ($verification->isExpired()) {\n            throw new Exception(__('otp::messages.code_expired'));\n        }\n\n        if ($verification->hasExceededAttempts(config('otp.max_attempts', 5))) {\n            throw new Exception(__('otp::messages.max_attempts_exceeded'));\n        }\n\n        if ($verification->code !== $code) {\n            $verification->incrementAttempts();\n            throw new Exception(__('otp::messages.invalid_code'));\n        }\n\n        $verification->markAsVerified();\n\n        return true;\n    }\n\n    /**\n     * Check if phone number is verified\n     */\n    public function isVerified(string $phoneNumber): bool\n    {\n        return PhoneVerification::where('phone_number', $phoneNumber)\n            ->whereNotNull('verified_at')\n            ->where('verified_at', '>=', now()->subMinutes(config('otp.verification_valid_minutes', 60)))\n            ->exists();\n    }\n\n    /**\n     * Generate a random OTP code\n     */\n    protected function generateCode(): string\n    {\n        $length = config('otp.code_length', 6);\n        return str_pad((string) random_int(0, pow(10, $length) - 1), $length, '0', STR_PAD_LEFT);\n    }\n\n    /**\n     * Send OTP code via Twilio SMS\n     */\n    protected function sendViaTwilio(string $phoneNumber, string $code): void\n    {\n        if (!$this->twilioClient || !$this->twilioFrom) {\n            // Log the code for development/testing when Twilio is not configured\n            \\Log::info(\"OTP Code for {$phoneNumber}: {$code}\");\n            return;\n        }\n\n        try {\n            $message = config('otp.message', 'Your verification code is: :code');\n            $message = str_replace(':code', $code, $message);\n\n            $this->twilioClient->messages->create(\n                $phoneNumber,\n                [\n                    'from' => $this->twilioFrom,\n                    'body' => $message,\n                ]\n            );\n        } catch (TwilioException $e) {\n            throw new Exception(__('otp::messages.sms_send_failed') . ': ' . $e->getMessage());\n        }\n    }\n}\n"
        }
    ]
}