{
    "sourceFile": "Modules/StagedForm/Repositories/StagedFormRepository.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 33,
            "patches": [
                {
                    "date": 1758627373389,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1758627384944,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,9 +95,9 @@\n     }\n \n     public function updateOrCreate(string $step, string $type, $userId, array $data)\n     {\n-        dd($step)\n+        dd($step, $type);\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"]\n         ];\n"
                },
                {
                    "date": 1758627391241,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,9 +95,9 @@\n     }\n \n     public function updateOrCreate(string $step, string $type, $userId, array $data)\n     {\n-        dd($step, $type);\n+        dd($step, $type, $userId);\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"]\n         ];\n"
                },
                {
                    "date": 1758627500934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,9 +95,8 @@\n     }\n \n     public function updateOrCreate(string $step, string $type, $userId, array $data)\n     {\n-        dd($step, $type, $userId);\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"]\n         ];\n"
                },
                {
                    "date": 1758627550112,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -102,9 +102,9 @@\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n-        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id']));\n+        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n \n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n"
                },
                {
                    "date": 1758627573086,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,8 +95,9 @@\n     }\n \n     public function updateOrCreate(string $step, string $type, $userId, array $data)\n     {\n+        dd($data);\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"]\n         ];\n"
                },
                {
                    "date": 1758627614566,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,9 +98,10 @@\n     {\n         dd($data);\n         $matchingArr = [\n             'stage_type' => $type,\n-            'stage_id' => $data[\"stage_id\"]\n+            'stage_id' => $data[\"stage_id\"],\n+            \n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627624409,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         dd($data);\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n-            \n+            'step' => $s\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627647771,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,17 +95,18 @@\n     }\n \n     public function updateOrCreate(string $step, string $type, $userId, array $data)\n     {\n-        dd($data);\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n-            'step' => $s\n+            'step' => $step\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n+\n+        dd($matchingArr);\n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n \n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n"
                },
                {
                    "date": 1758627663062,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,9 +104,9 @@\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n \n-        dd($matchingArr);\n+        dd(Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n \n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n"
                },
                {
                    "date": 1758627672153,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,9 +104,8 @@\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n \n-        dd(Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n \n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n"
                },
                {
                    "date": 1758627721562,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,10 +104,10 @@\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n \n-        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n-\n+        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n+dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n         ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n"
                },
                {
                    "date": 1758627743939,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,8 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step\n+            \n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627751365,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step\n-            \n+            'staged_forms' => $data\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627756739,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,10 +98,10 @@\n     {\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n-            'step' => $step\n-            'staged_forms' => $data\n+            'step' => $step,\n+            'staged_forms' => $data['staged_forms']\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627776593,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step,\n-            'staged_forms' => $data['staged_forms']\n+            'staged_forms' => $data['submitted_form']\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627788071,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step,\n-            'staged_forms' => $data['submitted_form']\n+            'staged_forms' => js\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627805897,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step,\n-            'staged_forms' => js\n+            'submitted_form' => json_encode($data['submitted_form'])\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627819791,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step,\n-            'submitted_form' => json_encode($data['submitted_form'])\n+            'submitted_form' => $data['submitted_form'])\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627834401,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step,\n-            'submitted_form' => $data['submitted_form'])\n+            'submitted_form' => json_encode($data['submitted_form'])\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627841839,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step,\n-            'submitted_form' => json_encode($data['submitted_form'])\n+            'submitted_form' => json_encode($data['submitted_form'], true)\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n"
                },
                {
                    "date": 1758627858955,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,9 +104,9 @@\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n-\n+dd($matchingArr);\n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n"
                },
                {
                    "date": 1758627875845,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,9 +104,9 @@\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n-dd($matchingArr);\n+dd($matchingArr, $data);\n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n"
                },
                {
                    "date": 1758627907480,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,10 +104,9 @@\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n-dd($matchingArr, $data);\n-        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n+\\       $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n"
                },
                {
                    "date": 1758627914691,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,9 +104,9 @@\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n-\\       $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n+        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n"
                },
                {
                    "date": 1758627931093,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,15 +99,16 @@\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n             'step' => $step,\n-            'submitted_form' => json_encode($data['submitted_form'], true)\n+            'submitted_form' => 'asdasdads'\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n-dd($stagedForm);\n+\n+        dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n         ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n"
                },
                {
                    "date": 1758627988726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,17 +98,16 @@\n     {\n         $matchingArr = [\n             'stage_type' => $type,\n             'stage_id' => $data[\"stage_id\"],\n-            'step' => $step,\n-            'submitted_form' => 'asdasdads'\n+            'step' => $step\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n+\n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n-\n-        dd($stagedForm);\n+dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n         ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n"
                },
                {
                    "date": 1758627996265,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,10 +104,10 @@\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n \n-        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n-dd($stagedForm);\n+        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n+\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n         ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n"
                },
                {
                    "date": 1758628009379,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,10 +104,10 @@\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n \n-        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step']));\n-\n+        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n+dd($stagedForm);\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n         ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n"
                },
                {
                    "date": 1758628017567,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -105,9 +105,9 @@\n             $matchingArr['user_id'] = $userId;\n         }\n \n         $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n-dd($stagedForm);\n+\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n         ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n"
                },
                {
                    "date": 1758628745283,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -97,17 +97,15 @@\n     public function updateOrCreate(string $step, string $type, $userId, array $data)\n     {\n         $matchingArr = [\n             'stage_type' => $type,\n-            'stage_id' => $data[\"stage_id\"],\n-            'step' => $step\n+            'stage_id' => $data[\"stage_id\"]\n         ];\n         if (!empty($userId)) {\n             $matchingArr['user_id'] = $userId;\n         }\n+        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id']));\n \n-        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id', 'step', 'submitted_form']));\n-\n         StagedFormStep::updateOrCreate([\n             'staged_form_id' => $stagedForm->getKey(),\n             'step' => $step,\n         ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n"
                },
                {
                    "date": 1758781979077,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -123,5 +123,12 @@\n         return StagedFormStep::whereStagedFormId($stagedFormId)\n             ->whereStep($step)\n             ->update($data);\n     }\n+\n+      public function getAllByStageId(string $stageId)\n+    {\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_forms.stage_id', $stageId)\n+            ->get());\n+    }\n }\n"
                },
                {
                    "date": 1758781993171,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -124,9 +124,9 @@\n             ->whereStep($step)\n             ->update($data);\n     }\n \n-    public function getAllByStageIdType(string $stageId)\n+    public function getAllByStageIdTypeU(string $stageId)\n     {\n         return $this->castingSubmittedForm($this->getQueryBuilder()\n             ->where('staged_forms.stage_id', $stageId)\n             ->get());\n"
                },
                {
                    "date": 1758782030437,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,137 @@\n+<?php\n+\n+namespace Modules\\StagedForm\\Repositories;\n+\n+use Illuminate\\Database\\Eloquent\\Collection;\n+use Illuminate\\Support\\Arr;\n+use Modules\\StagedForm\\Models\\StagedForm;\n+use Modules\\StagedForm\\Models\\StagedFormStep;\n+\n+class StagedFormRepository\n+{\n+    public function getByStageIdTypeAndStep(string $stageId, string $type, string $step): ?StagedForm\n+    {\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_forms.stage_id', $stageId)\n+            ->where('staged_forms.stage_type', $type)\n+            ->where('staged_form_steps.step', $step)\n+            ->first());\n+    }\n+\n+    private function getQueryBuilder()\n+    {\n+        return  StagedForm::query()\n+            ->join('staged_form_steps', 'staged_forms.id', 'staged_form_steps.staged_form_id')\n+            ->select(\n+                'staged_forms.id',\n+                'staged_forms.stage_id',\n+                'staged_forms.stage_type',\n+                'staged_forms.user_id',\n+                'staged_form_steps.step',\n+                'staged_form_steps.submitted_form',\n+                'staged_form_steps.staged_form_id'\n+            );\n+    }\n+\n+    private function castingSubmittedForm($stagedForms)\n+    {\n+        if ($stagedForms instanceof Collection) {\n+            foreach ($stagedForms as &$stagedForm) {\n+                $stagedForm->submitted_form = json_decode($stagedForm->submitted_form, true);\n+            }\n+        } else {\n+            if ($stagedForms != null) {\n+                $stagedForms->submitted_form = json_decode($stagedForms->submitted_form, true);\n+            }\n+        }\n+        return $stagedForms;\n+    }\n+\n+    public function getStageSubmittedFormsCount(string $stageId): int\n+    {\n+        return $this->getQueryBuilder()\n+            ->where('staged_forms.stage_id', $stageId)\n+            ->count();\n+    }\n+\n+    public function getAllByStageId(string $stageId)\n+    {\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_forms.stage_id', $stageId)\n+            ->get());\n+    }\n+\n+    public function getStepByUserId(string $type, string $step, int $userId): ?object\n+    {\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_form_steps.step', $step)\n+            ->where('staged_forms.stage_type', $type)\n+            ->where('staged_forms.user_id', $userId)\n+            ->orderByDesc('staged_forms.created_at')\n+            ->first());\n+    }\n+\n+    public function getAllByUserId(int $userId, string $type): ?object\n+    {\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_forms.user_id', $userId)\n+            ->where('staged_forms.stage_type', $type)\n+            ->get());\n+    }\n+\n+    public function getByUserId(int $userId): ?StagedForm\n+    {\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_forms.user_id', $userId)\n+            ->first());\n+    }\n+\n+    public function validateStageIdExists(?string $stageId, ?int $userId, ?string $stageType): bool\n+    {\n+        return StagedForm::whereStageId($stageId)\n+            ->whereStageType($stageType)\n+            ->whereUserId($userId)\n+            ->exists();\n+    }\n+\n+    public function updateOrCreate(string $step, string $type, $userId, array $data)\n+    {\n+        $matchingArr = [\n+            'stage_type' => $type,\n+            'stage_id' => $data[\"stage_id\"]\n+        ];\n+        if (!empty($userId)) {\n+            $matchingArr['user_id'] = $userId;\n+        }\n+        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id']));\n+\n+        StagedFormStep::updateOrCreate([\n+            'staged_form_id' => $stagedForm->getKey(),\n+            'step' => $step,\n+        ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n+\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_forms.stage_id', $stagedForm->stage_id)\n+            ->where('staged_forms.user_id', $userId)\n+            ->where('staged_forms.stage_type', $type)\n+            ->where('staged_form_steps.step', $step)\n+            ->first());\n+    }\n+\n+    public function updateStagedFormStep(int $stagedFormId, string $step, array $data): bool\n+    {\n+        return StagedFormStep::whereStagedFormId($stagedFormId)\n+            ->whereStep($step)\n+            ->update($data);\n+    }\n+\n+    public function getAllByStageIdTypeUserId(string $stageId, string $type, int $userId)\n+    {\n+        return $this->castingSubmittedForm($this->getQueryBuilder()\n+            ->where('staged_forms.stage_id', $stageId)\n+            ->where('staged_forms.stage_type', $stageId)\n+            ->where('staged_forms.stage_id', $stageId)\n+\n+            ->get());\n+    }\n+}\n"
                }
            ],
            "date": 1758627373389,
            "name": "Commit-0",
            "content": "<?php\n\nnamespace Modules\\StagedForm\\Repositories;\n\nuse Illuminate\\Database\\Eloquent\\Collection;\nuse Illuminate\\Support\\Arr;\nuse Modules\\StagedForm\\Models\\StagedForm;\nuse Modules\\StagedForm\\Models\\StagedFormStep;\n\nclass StagedFormRepository\n{\n    public function getByStageIdTypeAndStep(string $stageId, string $type, string $step): ?StagedForm\n    {\n        return $this->castingSubmittedForm($this->getQueryBuilder()\n            ->where('staged_forms.stage_id', $stageId)\n            ->where('staged_forms.stage_type', $type)\n            ->where('staged_form_steps.step', $step)\n            ->first());\n    }\n\n    private function getQueryBuilder()\n    {\n        return  StagedForm::query()\n            ->join('staged_form_steps', 'staged_forms.id', 'staged_form_steps.staged_form_id')\n            ->select(\n                'staged_forms.id',\n                'staged_forms.stage_id',\n                'staged_forms.stage_type',\n                'staged_forms.user_id',\n                'staged_form_steps.step',\n                'staged_form_steps.submitted_form',\n                'staged_form_steps.staged_form_id'\n            );\n    }\n\n    private function castingSubmittedForm($stagedForms)\n    {\n        if ($stagedForms instanceof Collection) {\n            foreach ($stagedForms as &$stagedForm) {\n                $stagedForm->submitted_form = json_decode($stagedForm->submitted_form, true);\n            }\n        } else {\n            if ($stagedForms != null) {\n                $stagedForms->submitted_form = json_decode($stagedForms->submitted_form, true);\n            }\n        }\n        return $stagedForms;\n    }\n\n    public function getStageSubmittedFormsCount(string $stageId): int\n    {\n        return $this->getQueryBuilder()\n            ->where('staged_forms.stage_id', $stageId)\n            ->count();\n    }\n\n    public function getAllByStageId(string $stageId)\n    {\n        return $this->castingSubmittedForm($this->getQueryBuilder()\n            ->where('staged_forms.stage_id', $stageId)\n            ->get());\n    }\n\n    public function getStepByUserId(string $type, string $step, int $userId): ?object\n    {\n        return $this->castingSubmittedForm($this->getQueryBuilder()\n            ->where('staged_form_steps.step', $step)\n            ->where('staged_forms.stage_type', $type)\n            ->where('staged_forms.user_id', $userId)\n            ->orderByDesc('staged_forms.created_at')\n            ->first());\n    }\n\n    public function getAllByUserId(int $userId, string $type): ?object\n    {\n        return $this->castingSubmittedForm($this->getQueryBuilder()\n            ->where('staged_forms.user_id', $userId)\n            ->where('staged_forms.stage_type', $type)\n            ->get());\n    }\n\n    public function getByUserId(int $userId): ?StagedForm\n    {\n        return $this->castingSubmittedForm($this->getQueryBuilder()\n            ->where('staged_forms.user_id', $userId)\n            ->first());\n    }\n\n    public function validateStageIdExists(?string $stageId, ?int $userId, ?string $stageType): bool\n    {\n        return StagedForm::whereStageId($stageId)\n            ->whereStageType($stageType)\n            ->whereUserId($userId)\n            ->exists();\n    }\n\n    public function updateOrCreate(string $step, string $type, $userId, array $data)\n    {\n        dd($step)\n        $matchingArr = [\n            'stage_type' => $type,\n            'stage_id' => $data[\"stage_id\"]\n        ];\n        if (!empty($userId)) {\n            $matchingArr['user_id'] = $userId;\n        }\n        $stagedForm = StagedForm::updateOrCreate($matchingArr, Arr::only(array: $data, keys: ['stage_type', 'stage_id', 'user_id']));\n\n        StagedFormStep::updateOrCreate([\n            'staged_form_id' => $stagedForm->getKey(),\n            'step' => $step,\n        ], Arr::only(array: $data, keys: ['step', 'submitted_form']));\n\n        return $this->castingSubmittedForm($this->getQueryBuilder()\n            ->where('staged_forms.stage_id', $stagedForm->stage_id)\n            ->where('staged_forms.user_id', $userId)\n            ->where('staged_forms.stage_type', $type)\n            ->where('staged_form_steps.step', $step)\n            ->first());\n    }\n\n    public function updateStagedFormStep(int $stagedFormId, string $step, array $data): bool\n    {\n        return StagedFormStep::whereStagedFormId($stagedFormId)\n            ->whereStep($step)\n            ->update($data);\n    }\n}\n"
        }
    ]
}